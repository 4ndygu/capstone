{% extends "registration/base.html" %}

{% block title %}User details{% endblock %}

{% block main_content %}
  <div class="user-information">
    <div class="row">
      <div class="h5 col-sm-12">Email</div>
      <div class="col-sm-12">{{ request.user.email }}</div>
    </div>
    <div class="row">
      <div class="h5 col-sm-12">API Key</div>
      {% if request.user.get_api_key %}
        <div class="col-sm-12">{{ request.user.get_api_key }}</div>
        <div class="col-sm-12">
          <a href="{% url 'reset-api-key' %}">
            Reset key
          </a>
        </div>
      {% else %}
        <div class="col-sm-12">
          <a href="{% url "reset-api-key" %}">
            Create key
          </a>
        </div>
      {% endif %}
    </div>
    {% if request.user.unlimited_access or request.user.harvard_access %}
      <div class="row">
        <div class="h5 col-sm-12">Unmetered access</div>
        <div class="col-sm-12">
          {% if request.user.unlimited_access_until %}
            {% if request.user.unlimited_access_in_effect %}expires{% else %}expired{% endif %}
            {{ request.user.unlimited_access_until }}
          {% else %}
            <strong>approved</strong>
          {% endif %}
          {% if request.user.harvard_access and not request.user.harvard_ip %}
            <div>
              Your Harvard unmetered access will only work when accessing this website from a Harvard IP address.
              Your current IP address of {{ request.user.ip_address }} is not a Harvard IP address.
            </div>
          {% endif %}
        </div>
      </div>
    {% else %}
      <div class="row">
        <div class="h5 col-sm-12">Case allowance</div>
        <div class="col-sm-12">
          <span class="case-number">{{ request.user.case_allowance_remaining }}</span> cases left today
        </div>
        <div class="col-sm-12">
          <span class="case-number">{{ request.user.total_case_allowance }}</span> total per day
        </div>
      </div>
      <div class="row">
        <div class="h5 col-sm-12">Unmetered access</div>
        <div class="col-sm-12">
          {% if research_contract %}
            You submitted an application for unmetered access on
            {{ research_contract.user_signature_date|date:"F j, Y" }}.
            {% if research_contract.status == "denied" %}
              Your application was denied by LexisNexis. Please contact us if you would like to discuss further options.
            {% else %}
              Your application is pending.
            {% endif %}
          {% elif research_request %}
            You submitted a request for unmetered access on {{ research_request.submitted_date }}
          {% else %}
            Are you a research scholar? <br/>
            <a href="{% if NEW_RESEARCHER_FEATURE %}{% url 'research-options' %}{% else %}{% url 'unaffiliated-research-request' %}{% endif %}">
              Request access
            </a>
          {% endif %}
        </div>
      </div>
    {% endif %}
    <div class="row">
      <div class="h5 col-sm-12">History</div>
      <div class="col-sm-12">
        <form class="history-form" method="POST">
          {% csrf_token %}
          {{ user_form.track_history }}
          <label for="{{ user_form.track_history.id_for_label }}">Track which cases I access</label>
          <div>
            <button class="btn btn-link p-0 m-0" type="button" data-toggle="collapse" data-target="#track-history-info" aria-expanded="false" aria-controls="track-history-info">
              What does this mean?
            </button>
          </div>
          <div>
            <button type="submit" class="btn btn-secondary m-0">Save</button>
            {% if user.track_history or user.has_tracked_history %}
              <a href="{% url "user-history" %}" class="btn btn-outline-secondary m-0">View history</a>
              <button type="button" class="btn btn-outline-danger m-0" data-toggle="modal" data-target="#delete-modal">
                Delete history
              </button>
              <div class="modal" id="delete-modal" tabindex="-1" role="dialog" aria-labelledby="delete-modal-label" aria-hidden="true">
                <div class="modal-dialog" role="document">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="delete-modal-label">Delete history</h5>
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                      </button>
                    </div>
                    <div class="modal-body">
                      Really delete your history?
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                      <button type="submit" class="btn btn-danger" name="delete" value="true">Delete</button>
                    </div>
                  </div>
                </div>
              </div>
            {% endif %}
          </div>
        </form>
        <div>
        </div>
        <div class="collapse" id="track-history-info">
          <div class="card card-body">
            <ul class="bullets">
              <li>
                Tracking the cases you access allows us to enable optional features for your account, such as the
                ability to provide the same case repeatedly without counting it separately against your daily quota.
              </li>
              <li>We only track the cases you access if you specifically tell us to do so.</li>
              <li>We only use the list of cases you access to enable optional features.</li>
              <li>
                We will not review or disclose the list of cases you access unless compelled by law, or to investigate
                violations of our terms of use.
              </li>
              <li>You can permanently delete your history from our servers at any time.</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <hr/>
    <div class="row">
      <div class="col-sm-12">
        <a href="{% url 'logout' %}"
           class="btn btn-primary">
          Log out
        </a>
      </div>
      <div class="col-sm-12">
        <a href="{% url 'password_change' %}">
          Change password
        </a>
      </div>
    </div>
    <div class="row">
      <br/><br/>
      <div class="col-sm-12">
        <a href="{% url 'delete_account' %}"
           class="text-danger delete-account-link">
          Delete account
        </a>
      </div>
    </div>
  </div>
{% endblock %}
