{% extends "main_base.html" %}
{% load static %}
{% load pipeline %}
{% load api_url %}

{% block extra_head %}
  {% stylesheet 'browse_case' %}
{% endblock %}

{% block title %}Caselaw Access Project| View Case {% endblock %}

{% block meta_description %}
  About the Caselaw Access Project
{% endblock %}


{% block content %}

  <noscript>
    <div style="height: 100%; padding: 20%;">
      This case viewer requires javascript, but you can view a simple HTML version of the case through our API.
      <a href="{% api_url "casemetadata-list" %}{{ case_id }}/?full_case=true&format=html">Click here to view the case
      HTML in our API.</a> If that link returns "Error: Not Authenticated," log in using the link in the nav bar on this
      page, and revisit the case link. If you need help, visit the contact page to see how you can get in touch.
    </div>
  </noscript>

    <div id="loading-overlay">
        <img alt="" aria-hidden="true" src='{% static "img/loading.gif" %}' class="loading-gif"/>
        <div class="loading-text">Loading</div>
    </div>
  <div class="basic-page">
    <div id="app"  class="full-content">
      <div class="top-section">
          <div class="title-section">
            <h1 class="page-title" id="case-title">
              <img alt="" aria-hidden="true" src='{% static "img/red-arrow-right.svg" %}' class="decorative-arrow"/>
              [[title]]
            </h1>
              <div id="metadata-block">
                  <div>
                    <ul id="citation_list">
                      <li v-for="citation in citations">
                          <span class="metadata-citation">[[ citation.cite ]]</span>
                          <span class="metadata-citation-type">([[ citation.type ]])</span>
                      </li>
                    </ul>

                  </div>
                  <div>
                    <span id="metadata-reporter" v-text="reporter"></span>
                    <span id="metadata-vol" v-text="vol_no"></span>
                    <span id="metadata-pages" v-text="pages"></span>
                    <span id="metadata-decdate" v-text="decdate"></span>
                </div>
              </div>
          </div>
      </div>
      <div class="row below-the-fold">
        <div class="main-content">
            <div v-html="casebody" class="content">
            </div>

          </div>
        </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/vue@2.5.17/dist/vue.js"></script>
  <script>
  var app = new Vue({
    el: '#app',
      data: {
          title: "Loading Case...",
          citations: [],
          reporter: "",
          vol_no: "",
          pages: "",
          casebody: "",
          decdate: ""
    },
    methods:{
     getCase: function() {
      case_url = '{% api_url "casemetadata-list" %}{{ case_id }}/?full_case=true&body_format=html'


      // This adds the user's API key if they're logged in. The API key is dynamically generated with python, so if
      // you're looking at this code in your browser wondering why we're testing if a blank string is a blank string,
      // that's why.
      if ("{{ request.user.get_api_key }}" === "") {
        headers = {}
      } else {
        headers = { "Authorization": "Token {{ request.user.get_api_key }}" }
      }

      fetch(case_url, { headers: headers })
      .then(function(response) { return response.json(); })
      .then(function(case_json) {
        console.log(case_json);

        if ('detail' in case_json && case_json.detail == "Not found."){
            app.casebody = "There doesn't seem to be a case associated with the case id {{ case_id }}. If you got here "+
                "through a link on our site or in our API, please " +
                "<a href='https://caselaw.freshdesk.com/support/tickets/new'>click here</a> to let us know."
            document.getElementById("metadata-block").style.display = "none"
            app.title = "Case Not Found"
            return false
        }

        if ('detail' in case_json && case_json.detail == "Not found."){
            app.casebody = "There doesn't seem to be a case associated with the case id {{ case_id }}. If you got here "+
                "through a link on our site or in our API, please " +
                "<a href='https://caselaw.freshdesk.com/support/tickets/new'>click here</a> to let us know."
            document.getElementById("metadata-block").style.display = "none"
            app.title = "Case Not Found"
            return false
        }

        app.title=case_json.name_abbreviation
          app.reporter = case_json.reporter.full_name
          app.vol_no = case_json.volume.volume_number
          app.pages = case_json.first_page + " - " + case_json.last_page
          app.decdate = case_json.decision_date
          document.title = "Caselaw Access Project| " + case_json.name_abbreviation
          app.citations = []
          case_json.citations.forEach( function (citation) {
              console.log(citation.cite)
              app.citations.push({
                  "cite": citation.cite,
                  "type": citation.type
              })

          })
        if (case_json.casebody.status === "error_limit_exceeded") {
            app.casebody = "Sorry, we can't load this case because you've accessed the maximum number of " +
                "non-whitelisted cases we are allowed to share with you in a 24 hour period. You can still access lots " +
                "of data without having to wait until tomorrow. To learn more about the usage limits, what you can " +
                "access when you've hit the limit, and see if you qualify to be exempted from them " +
                "<a href='http://case.test:8000/api/#limits'>click here</a>."
        }
        else if(case_json.casebody.status === "error_auth_required") {
            app.casebody = "This case is not from a whitelisted jurisdiction, so you must be logged in to view it. " +
                "To learn more about the usage limits, and see if you qualify to be exempted from them " +
                "<a href='http://case.test:8000/api/#limits'>click here</a>."
        } else {
            app.casebody = case_json.casebody.data
        }

      })
      .then(function(){ document.getElementById("loading-overlay").style.display = 'none'; });
     }
    },
    beforeMount() {
      this.getCase()
    },
    delimiters: ['[[', ']]'],
});
  </script>


{% endblock %}
